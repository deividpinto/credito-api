# API de Cr√©dito

## üìã Pr√©-requisitos

Para executar este projeto, voc√™ precisar√° ter instalado em sua m√°quina:

- Java 17
- Docker
- Docker Compose
- PostgreSQL 
- Maven (para build do projeto)

## üõ†Ô∏è Configura√ß√£o do Ambiente

### 1. Banco de Dados

O projeto utiliza PostgreSQL. Configure-o com as seguintes credenciais:
Database:  `credito_db` Username: `admin` Password: `123456` Port: `5432`

Criando o usuario de banco usado na aplica√ß√£o:

`CREATE USER admin WITH PASSWORD '123456';`

`CREATE DATABASE credito_db OWNER admin;`

`GRANT ALL PRIVILEGES ON DATABASE credito_db TO admin;`

Criando o schema financeiro
`CREATE SCHEMA financeiro AUTHORIZATION admin;`

Cria√ß√£o da tabela de cr√©dito no schema financeiro

`CREATE TABLE financeiro.credito
(
    id            	BIGINT GENERATED BY DEFAULT AS IDENTITY,
    numero_credito	VARCHAR(50)	NOT NULL,
    numero_nfse   	VARCHAR(50)	NOT NULL,
    data_constituicao DATE       	NOT NULL,
    valor_issqn   	DECIMAL(15, 2) NOT NULL,
    tipo_credito  	VARCHAR(50)	NOT NULL,
    simples_nacional  BOOLEAN    	NOT NULL,
    aliquota      	DECIMAL(5, 2)  NOT NULL,
    valor_faturado	DECIMAL(15, 2) NOT NULL,
    valor_deducao 	DECIMAL(15, 2) NOT NULL,
    base_calculo  	DECIMAL(15, 2) NOT NULL
);`

Inserindo os registros:

`INSERT INTO financeiro.credito (numero_credito, numero_nfse, data_constituicao, valor_issqn, tipo_credito, simples_nacional, aliquota, valor_faturado, valor_deducao, base_calculo)
VALUES
('123456', '7891011', '2024-02-25', 1500.75, 'ISSQN', true, 5.0, 30000.00, 5000.00, 25000.00),
('789012', '7891011', '2024-02-26', 1200.50, 'ISSQN', false, 4.5, 25000.00, 4000.00, 21000.00),
('654321', '1122334', '2024-01-15', 800.50, 'Outros', true, 3.5, 20000.00, 3000.00, 17000.00);
`

Criando o schema de cadastro:

`CREATE SCHEMA cadastro AUTHORIZATION admin;`

Criando a tabela de usu√°rio para autentica√ß√£o na aplica√ß√£o:

`CREATE TABLE cadastro.usuario
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY,
    nome	      VARCHAR(100)	NOT NULL,
    senha   	  VARCHAR(100)	NOT NULL,
    email   	  VARCHAR(80)	NOT NULL,
    perfil   	  VARCHAR(80)	NOT NULL,
    data_cadastro TIMESTAMP NOT NULL DEFAULT CURRENT_DATE
);`

Inserindo um usu√°rio para logar:
> ‚ÑπÔ∏è **Nota:**
Para autenticar na aplica√ß√£o usar o email: teste@email.com e a senha: teste123

`INSERT INTO cadastro.usuario (nome, senha, email, perfil, data_cadastro)
VALUES ('Deivid', '$2a$10$mZexEOGMW27iMd9H5blCBOeXbi.dNBxuZSWWFWKS2OnCwDx8dgqtu',
        'teste@email.com', 'admin', '2025-07-25 00:00:00.000000');`

#### Banco de testes
> ‚ÑπÔ∏è **Nota:**
Foi criado um banco de teste local, mas pode ser usado um banco em mem√≥ria, so alterar o properties de test para usa-lo, as configura√ß√µes est√£o l√°, s√≥ descomentar

Crianddo o banco de teste:

`CREATE USER adminteste WITH PASSWORD 'teste123';`

`CREATE DATABASE teste_credito_db OWNER adminteste;`

`GRANT ALL PRIVILEGES ON DATABASE teste_credito_db TO adminteste;`

Criando o schema financeiro
`CREATE SCHEMA financeiro AUTHORIZATION adminteste;`

Cria√ß√£o da tabela de cr√©dito no schema financeiro de teste

`CREATE TABLE financeiro.credito
(
    id            	BIGINT GENERATED BY DEFAULT AS IDENTITY,
    numero_credito	VARCHAR(50)	NOT NULL,
    numero_nfse   	VARCHAR(50)	NOT NULL,
    data_constituicao DATE       	NOT NULL,
    valor_issqn   	DECIMAL(15, 2) NOT NULL,
    tipo_credito  	VARCHAR(50)	NOT NULL,
    simples_nacional  BOOLEAN    	NOT NULL,
    aliquota      	DECIMAL(5, 2)  NOT NULL,
    valor_faturado	DECIMAL(15, 2) NOT NULL,
    valor_deducao 	DECIMAL(15, 2) NOT NULL,
    base_calculo  	DECIMAL(15, 2) NOT NULL
);`

> ‚ÑπÔ∏è **Nota:**
Os registros v√£o ser inseridos e excluidos pelo setup de teste

### 2. Rede Docker

> ‚ÑπÔ∏è **Nota:**
A rede 'credito-network' deve ser criada antes de iniciar os containers

‚ö° Essa rede serve para conectar com a rede da api de credito, caso j√° tenha sido criado pela api, n√£o √© necess√°rio criar novamente. ‚ö°

Antes de iniciar a aplica√ß√£o, √© necess√°rio criar a rede Docker externa:

`docker network create credito-network`

## üöÄ Executando o Projeto

### 1. Configura√ß√£o do ambiente de desenvolvimento

O arquivo `application.properties` j√° est√° configurado com as configura√ß√µes necess√°rias para:
- Conex√£o com PostgreSQL
- Configura√ß√µes do JWT
- Configura√ß√µes do Kafka
- Pool de conex√µes (Hikari)
- Configura√ß√µes de logging

### 2. Iniciando os Servi√ßos

Execute o comando abaixo para iniciar todos os servi√ßos necess√°rios:

`docker-compose up -d`

Este comando ir√° iniciar:
- API de Cr√©dito (porta 8080)
- Zookeeper (porta 2181)
- Kafka (porta 9092)
- Kafka UI (porta 8081)

### 3. Verificando os Servi√ßos

Voc√™ pode acessar:
- API: http://localhost:8080
- Interface Kafka: http://localhost:8081

## üîß Tecnologias Utilizadas

- Spring Boot
- Spring Data JPA
- Spring MVC
- Jakarta EE
- Lombok
- Apache Kafka
- PostgreSQL
- Docker
- JWT para autentica√ß√£o

## üìä Monitoramento

- Kafka UI dispon√≠vel em http://localhost:8081
- Logs da aplica√ß√£o configurados em modo DEBUG para o pacote `com.credito.api`

## ‚öôÔ∏è Vari√°veis de Ambiente

As principais vari√°veis de ambiente que podem ser configuradas:

properties 
SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/credito_db
SPRING_DATASOURCE_USERNAME=admin
SPRING_DATASOURCE_PASSWORD=123456
SPRING_KAFKA_BOOTSTRAP_SERVERS=localhost:9092


## üõë Encerrando os Servi√ßos

Para parar todos os servi√ßos:

`docker-compose down`

## üí° Observa√ß√µes

- A aplica√ß√£o est√° configurada para usar o perfil `dev` por padr√£o
- O servidor est√° configurado para shutdown graceful
- O pool de conex√µes est√° limitado a 10 conex√µes simult√¢neas
- T√≥picos Kafka s√£o criados automaticamente quando necess√°rio
